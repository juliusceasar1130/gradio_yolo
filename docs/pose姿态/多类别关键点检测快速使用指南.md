# 多类别关键点检测快速使用指南

## 📋 文档信息
- **创建者/修改者**: chenliang
- **修改时间**: 2025年1月27日
- **主要修改内容**: 多类别关键点检测快速使用指南

---

## 🎯 问题解答

**问题**: 如果图片数据集里有2种形状，比如三角形和四边形，该如何进行标注和yaml文件设置？

**答案**: 使用多类别关键点检测方案，以下是完整解决方案：

---

## 🚀 快速解决方案

### 1. 创建标签文件

在图像文件夹中创建 `multi_class_labels.txt`：

```txt
# 多类别关键点标签文件
# 格式: 类别名_关键点名

# triangle 的关键点
triangle_top
triangle_bottom_left
triangle_bottom_right

# quadrilateral 的关键点
quadrilateral_top_left
quadrilateral_top_right
quadrilateral_bottom_right
quadrilateral_bottom_left
```

### 2. Labelme标注方法

#### 标注三角形：
1. 使用 "Create Rectangle" 框选三角形
2. 在Label字段输入：`triangle`
3. 标注3个关键点：
   - `triangle_top` (顶点)
   - `triangle_bottom_left` (左下角)
   - `triangle_bottom_right` (右下角)

#### 标注四边形：
1. 使用 "Create Rectangle" 框选四边形
2. 在Label字段输入：`quadrilateral`
3. 标注4个关键点：
   - `quadrilateral_top_left` (左上角)
   - `quadrilateral_top_right` (右上角)
   - `quadrilateral_bottom_right` (右下角)
   - `quadrilateral_bottom_left` (左下角)

### 3. 转换格式

```bash
# 使用多类别转换工具
python labelme_to_yolo_pose_multi_class.py \
    --input_dir /path/to/json/files \
    --output_dir /path/to/yolo/labels \
    --create_yaml \
    --create_labels \
    --dataset_name triangle_quad_dataset \
    --dim 3
```

### 4. YAML配置文件

自动生成的YAML配置：

```yaml
# 数据集路径
path: ./triangle_quad_dataset
train: images/train
val: images/val

# 关键点配置
kpt_shape: [4, 3]  # 最大4个关键点，3个维度

# 类别配置
nc: 2
names:
  0: triangle
  1: quadrilateral

# 关键点名称
kpt_names:
  0:  # triangle (3个关键点)
    - top
    - bottom_left
    - bottom_right
  1:  # quadrilateral (4个关键点)
    - top_left
    - top_right
    - bottom_right
    - bottom_left

# 骨架连接
skeleton:
  # triangle的骨架连接
  - [0, 1]  # top -> bottom_left
  - [1, 2]  # bottom_left -> bottom_right
  - [2, 0]  # bottom_right -> top
  # quadrilateral的骨架连接
  - [0, 1]  # top_left -> top_right
  - [1, 2]  # top_right -> bottom_right
  - [2, 3]  # bottom_right -> bottom_left
  - [3, 0]  # bottom_left -> top_left
```

### 5. 训练模型

```bash
# 训练多类别模型
python pose_training_tool.py train \
    --data triangle_quad_dataset.yaml \
    --epochs 100 \
    --batch 16 \
    --model_size s
```

---

## 📁 创建的文件

### 核心工具
- `labelme_to_yolo_pose_multi_class.py` - 多类别转换工具
- `multi_class_example.py` - 使用示例脚本
- `configs/multi_class_pose_template.yaml` - YAML配置模板

### 文档
- `docs/多类别关键点检测指南.md` - 详细指南
- `docs/多类别关键点检测快速使用指南.md` - 本文件

---

## 🎯 关键要点

### 1. 标注规范
- **类别区分**: 通过Label字段区分不同形状
- **关键点命名**: 使用 `类别名_关键点名` 格式
- **顺序一致**: 同类别的关键点顺序在所有图像中保持一致

### 2. 配置要点
- **kpt_shape**: 使用最大关键点数量（这里是4）
- **类别映射**: 每个类别有独立的class_id
- **关键点数量**: 不同类别可以有不同数量的关键点

### 3. 训练要点
- **数据平衡**: 确保每个类别有足够的训练样本
- **模型选择**: 建议使用 `yolo11s-pose.pt` 作为起点
- **批次大小**: 根据GPU内存调整，建议8-16

---

## 🚀 一键使用

```bash
# 1. 设置数据集
python multi_class_example.py --mode setup

# 2. 查看标注说明
python multi_class_example.py --mode instructions

# 3. 转换格式
python multi_class_example.py --mode convert

# 4. 训练模型
python multi_class_example.py --mode train

# 5. 验证模型
python multi_class_example.py --mode validate --model_path path/to/model.pt
```

---

## 🔧 扩展应用

### 添加更多形状类别

修改转换脚本中的类别映射：

```python
class_mapping = {
    'triangle': {
        'class_id': 0,
        'keypoints': ['top', 'bottom_left', 'bottom_right']
    },
    'quadrilateral': {
        'class_id': 1,
        'keypoints': ['top_left', 'top_right', 'bottom_right', 'bottom_left']
    },
    'pentagon': {
        'class_id': 2,
        'keypoints': ['top', 'top_right', 'bottom_right', 'bottom_left', 'top_left']
    }
}
```

### 自定义关键点

根据您的具体需求定义关键点：

```python
# 例如：检测人脸关键点
class_mapping = {
    'face': {
        'class_id': 0,
        'keypoints': ['left_eye', 'right_eye', 'nose', 'mouth_left', 'mouth_right']
    }
}
```

---

## 📝 总结

对于包含多种形状的数据集：

1. **标注时**: 使用不同的Label区分类别，关键点命名包含类别信息
2. **转换时**: 使用多类别转换工具，自动处理类别映射
3. **配置时**: YAML文件支持多类别，使用最大关键点数量
4. **训练时**: 模型会自动学习不同类别的关键点模式

这套方案可以轻松扩展到更多形状类别，满足各种多类别关键点检测需求。

---

*文档版本: v1.0*  
*最后更新: 2025年1月27日*
