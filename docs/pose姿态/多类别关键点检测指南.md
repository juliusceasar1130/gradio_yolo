# 多类别关键点检测标注指南

## 📋 文档信息
- **创建者/修改者**: chenliang
- **修改时间**: 2025年1月27日
- **主要修改内容**: 多类别关键点检测标注指南

---

## 🎯 概述

本指南详细介绍如何在同一个数据集中标注多种形状的关键点，以三角形和四边形为例，展示完整的多类别关键点检测流程。

---

## 📁 文件说明

### 核心文件
- `labelme_to_yolo_pose_multi_class.py` - 多类别转换工具
- `docs/多类别关键点检测指南.md` - 本指南文档

---

## 🚀 快速开始

### 1. 环境准备

```bash
# 激活conda环境
conda activate gradioflask

# 安装labelme
pip install labelme
```

### 2. 创建多类别标签文件

#### 2.1 创建标签文件

在图像文件夹中创建 `multi_class_labels.txt`：

```txt
# 多类别关键点标签文件
# 格式: 类别名_关键点名

# triangle 的关键点
triangle_top
triangle_bottom_left
triangle_bottom_right

# quadrilateral 的关键点
quadrilateral_top_left
quadrilateral_top_right
quadrilateral_bottom_right
quadrilateral_bottom_left
```

#### 2.2 使用Labelme标注多类别

**标注步骤：**

1. **启动Labelme**
   ```bash
   labelme
   ```

2. **加载标签文件**
   - 点击 "Tools" → "Load Labels" 加载 `multi_class_labels.txt`

3. **标注三角形**
   - 使用 "Create Rectangle" 框选三角形
   - 在Label字段中输入：`triangle`
   - 使用 "Create Point" 标注三个关键点：
     - `triangle_top` (顶点)
     - `triangle_bottom_left` (左下角)
     - `triangle_bottom_right` (右下角)

4. **标注四边形**
   - 使用 "Create Rectangle" 框选四边形
   - 在Label字段中输入：`quadrilateral`
   - 使用 "Create Point" 标注四个关键点：
     - `quadrilateral_top_left` (左上角)
     - `quadrilateral_top_right` (右上角)
     - `quadrilateral_bottom_right` (右下角)
     - `quadrilateral_bottom_left` (左下角)

5. **保存标注结果**
   - 每个图像保存为对应的JSON文件

### 3. 转换格式

#### 3.1 基础转换

```bash
# 转换多类别Labelme JSON文件为YOLO格式
python labelme_to_yolo_pose_multi_class.py \
    --input_dir /path/to/json/files \
    --output_dir /path/to/yolo/labels \
    --dim 3
```

#### 3.2 创建标签文件和YAML配置

```bash
# 转换并创建所有配置文件
python labelme_to_yolo_pose_multi_class.py \
    --input_dir /path/to/json/files \
    --output_dir /path/to/yolo/labels \
    --create_yaml \
    --create_labels \
    --dataset_name triangle_quad_dataset \
    --dim 3
```

### 4. 训练模型

#### 4.1 使用多类别配置训练

```bash
# 训练多类别Pose模型
python pose_training_tool.py train \
    --data triangle_quad_dataset.yaml \
    --epochs 100 \
    --batch 16 \
    --model_size s
```

#### 4.2 验证模型

```bash
# 验证多类别模型
python pose_training_tool.py validate \
    --model pose_training/custom_model/weights/best.pt \
    --image test_image.jpg
```

---

## 📋 详细标注示例

### 示例1：三角形标注

#### 1. 三角形关键点定义
```
类别: triangle (class_id: 0)
关键点:
  - top: 顶点
  - bottom_left: 左下角
  - bottom_right: 右下角
```

#### 2. Labelme标注步骤
1. 框选整个三角形区域
2. 设置Label为 `triangle`
3. 标注三个关键点：
   - 顶点：`triangle_top`
   - 左下角：`triangle_bottom_left`
   - 右下角：`triangle_bottom_right`

#### 3. JSON标注示例
```json
{
  "shapes": [
    {
      "label": "triangle",
      "points": [[100, 50], [200, 150]],
      "shape_type": "rectangle"
    },
    {
      "label": "triangle_top",
      "points": [[150, 50]],
      "shape_type": "point"
    },
    {
      "label": "triangle_bottom_left",
      "points": [[100, 150]],
      "shape_type": "point"
    },
    {
      "label": "triangle_bottom_right",
      "points": [[200, 150]],
      "shape_type": "point"
    }
  ]
}
```

### 示例2：四边形标注

#### 1. 四边形关键点定义
```
类别: quadrilateral (class_id: 1)
关键点:
  - top_left: 左上角
  - top_right: 右上角
  - bottom_right: 右下角
  - bottom_left: 左下角
```

#### 2. Labelme标注步骤
1. 框选整个四边形区域
2. 设置Label为 `quadrilateral`
3. 标注四个关键点：
   - 左上角：`quadrilateral_top_left`
   - 右上角：`quadrilateral_top_right`
   - 右下角：`quadrilateral_bottom_right`
   - 左下角：`quadrilateral_bottom_left`

#### 3. JSON标注示例
```json
{
  "shapes": [
    {
      "label": "quadrilateral",
      "points": [[50, 30], [250, 180]],
      "shape_type": "rectangle"
    },
    {
      "label": "quadrilateral_top_left",
      "points": [[50, 30]],
      "shape_type": "point"
    },
    {
      "label": "quadrilateral_top_right",
      "points": [[250, 30]],
      "shape_type": "point"
    },
    {
      "label": "quadrilateral_bottom_right",
      "points": [[250, 180]],
      "shape_type": "point"
    },
    {
      "label": "quadrilateral_bottom_left",
      "points": [[50, 180]],
      "shape_type": "point"
    }
  ]
}
```

---

## 🔧 高级用法

### 1. 自定义类别映射

#### 修改转换脚本中的类别映射

```python
# 在 labelme_to_yolo_pose_multi_class.py 中修改
class_mapping = {
    'triangle': {
        'class_id': 0,
        'keypoints': ['top', 'bottom_left', 'bottom_right']
    },
    'quadrilateral': {
        'class_id': 1,
        'keypoints': ['top_left', 'top_right', 'bottom_right', 'bottom_left']
    },
    # 添加更多类别
    'pentagon': {
        'class_id': 2,
        'keypoints': ['top', 'top_right', 'bottom_right', 'bottom_left', 'top_left']
    }
}
```

### 2. 不同关键点数量的处理

#### 2.1 YAML配置中的关键点形状

```yaml
# 关键点配置 - 使用最大关键点数量
kpt_shape: [4, 3]  # 最大4个关键点，3个维度

# 关键点名称
kpt_names:
  0:  # triangle (3个关键点)
    - top
    - bottom_left
    - bottom_right
  1:  # quadrilateral (4个关键点)
    - top_left
    - top_right
    - bottom_right
    - bottom_left
```

#### 2.2 处理不同数量的关键点

- **三角形**: 3个关键点，第4个位置填充0
- **四边形**: 4个关键点，全部使用
- **训练时**: 模型会自动学习不同类别的关键点模式

### 3. 骨架连接配置

#### 3.1 三角形骨架
```yaml
skeleton:
  - [0, 1]  # top -> bottom_left
  - [1, 2]  # bottom_left -> bottom_right
  - [2, 0]  # bottom_right -> top
```

#### 3.2 四边形骨架
```yaml
skeleton:
  - [0, 1]  # top_left -> top_right
  - [1, 2]  # top_right -> bottom_right
  - [2, 3]  # bottom_right -> bottom_left
  - [3, 0]  # bottom_left -> top_left
```

---

## 🎯 最佳实践

### 1. 标注质量
- **一致性**: 确保同类别的关键点顺序在所有图像中保持一致
- **准确性**: 关键点标注要精确到像素级别
- **完整性**: 每个对象都要标注完整的边界框和关键点

### 2. 数据平衡
- **类别平衡**: 确保每个类别有足够的训练样本
- **角度多样性**: 包含不同角度、光照条件的图像
- **验证集**: 建议验证集占20%，且各类别比例与训练集相似

### 3. 关键点命名规范
- **格式**: `类别名_关键点名`
- **示例**: `triangle_top`, `quadrilateral_top_left`
- **一致性**: 所有标注人员使用相同的命名规范

### 4. 模型训练建议
- **预训练模型**: 使用 `yolo11s-pose.pt` 作为起点
- **批次大小**: 根据GPU内存调整，建议8-16
- **学习率**: 多类别检测可能需要更小的学习率
- **训练轮数**: 建议100-200轮，观察收敛情况

---

## 🐛 常见问题

### 1. 关键点顺序错误
**问题**: 转换后的关键点顺序不正确
**解决**: 
- 检查标签文件中的关键点顺序
- 确保标注时按照预定义的顺序进行
- 使用一致的命名规范

### 2. 类别映射错误
**问题**: 某些类别无法正确识别
**解决**:
- 检查Labelme中的Label字段是否与类别映射匹配
- 确保类别名称大小写一致
- 验证JSON文件中的标签格式

### 3. 关键点数量不匹配
**问题**: 不同类别的关键点数量不同
**解决**:
- 在YAML中使用最大关键点数量
- 较少的类别用0填充缺失的关键点
- 确保骨架连接配置正确

### 4. 训练不收敛
**问题**: 多类别模型训练效果差
**解决**:
- 检查数据质量和标注一致性
- 调整学习率和批次大小
- 增加训练数据
- 使用数据增强技术

---

## 📚 扩展应用

### 1. 添加更多形状类别

```python
# 扩展类别映射
class_mapping = {
    'triangle': {
        'class_id': 0,
        'keypoints': ['top', 'bottom_left', 'bottom_right']
    },
    'quadrilateral': {
        'class_id': 1,
        'keypoints': ['top_left', 'top_right', 'bottom_right', 'bottom_left']
    },
    'pentagon': {
        'class_id': 2,
        'keypoints': ['top', 'top_right', 'bottom_right', 'bottom_left', 'top_left']
    },
    'hexagon': {
        'class_id': 3,
        'keypoints': ['top', 'top_right', 'bottom_right', 'bottom_left', 'top_left', 'center']
    }
}
```

### 2. 复杂形状的关键点设计

#### 2.1 人体姿态检测
```python
class_mapping = {
    'person': {
        'class_id': 0,
        'keypoints': [
            'nose', 'left_eye', 'right_eye', 'left_ear', 'right_ear',
            'left_shoulder', 'right_shoulder', 'left_elbow', 'right_elbow',
            'left_wrist', 'right_wrist', 'left_hip', 'right_hip',
            'left_knee', 'right_knee', 'left_ankle', 'right_ankle'
        ]
    }
}
```

#### 2.2 车辆关键点检测
```python
class_mapping = {
    'car': {
        'class_id': 0,
        'keypoints': [
            'front_left', 'front_right', 'rear_left', 'rear_right',
            'center_front', 'center_rear'
        ]
    },
    'truck': {
        'class_id': 1,
        'keypoints': [
            'front_left', 'front_right', 'rear_left', 'rear_right',
            'cab_front', 'cab_rear', 'trailer_front', 'trailer_rear'
        ]
    }
}
```

---

## 📝 更新日志

### v1.0 (2025-01-27)
- 初始版本
- 支持三角形和四边形多类别检测
- 提供完整的标注和转换流程
- 支持自定义类别映射
- 提供详细的标注示例和最佳实践

---

*文档版本: v1.0*  
*最后更新: 2025年1月27日*
